{% extends "base.html" %}

{% block title %}My Reviews - Analyst Dashboard{% endblock %}

{% block content %}
<div class="content-area">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-clipboard-check text-primary"></i> My Security Reviews</h2>
            <p class="text-muted">Review and analyze assigned security assessments</p>
        </div>
    </div>

    <!-- Statistics Cards (Updated for completed count fix) -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Reviews</div>
                    <div class="h4 mb-0 font-weight-bold text-gray-800">
                        {% set total_reviews = applications|sum(attribute='review_count') %}
                        {{ total_reviews }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">In Progress</div>
                    <div class="h4 mb-0 font-weight-bold text-gray-800">
                        {% set in_progress_reviews = [] %}
                        {% for app in applications %}
                            {% for review in app.reviews %}
                                {% if review.status == 'in_review' %}
                                    {% set _ = in_progress_reviews.append(1) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {{ in_progress_reviews|length }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Completed</div>
                    <div class="h4 mb-0 font-weight-bold text-gray-800">
                        {# Use a more reliable method to count completed reviews #}
                        {% set completed_reviews = [] %}
                        {% for app in applications %}
                            {% for review in app.reviews %}
                                {% if review.status == 'completed' %}
                                    {% set _ = completed_reviews.append(1) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {{ completed_reviews|length }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Table -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Assigned Reviews
            </h6>
        </div>
        <div class="card-body">
            {% if applications %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Available Reviews</th>
                            <th>Author</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications %}
                        <tr>
                            <td>
                                <strong>{{ app.app_name }}</strong>
                                <br>
                                <small class="text-muted">{{ app.review_count }} review{{ 's' if app.review_count > 1 else '' }} available</small>
                                {% if app.technology_stack %}
                                <br>
                                <small class="text-muted">
                                    {{ app.technology_stack[:30] }}{{ '...' if app.technology_stack|length > 30 else '' }}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                {% for review in app.reviews %}
                                {% if review.field_type == 'application_review' %}
                                        <span class="badge me-1 mb-1" style="background-color: #007bff; color: white; font-weight: bold;">Application Review</span>
                                {% elif review.field_type == 'cloud_review' %}
                                        <span class="badge me-1 mb-1" style="background-color: #17a2b8; color: white; font-weight: bold;">Cloud Review</span>
                                {% else %}
                                        <span class="badge me-1 mb-1" style="background-color: #6c757d; color: white; font-weight: bold;">{{ review.field_type|title }}</span>
                                {% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                <div>{{ app.author_name }}</div>
                                <small class="text-muted">{{ app.email }}</small>
                            </td>
                            <td>
                                {% if app.business_criticality == 'Critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                {% elif app.business_criticality == 'High' %}
                                    <span class="badge bg-warning text-dark">High</span>
                                {% elif app.business_criticality == 'Medium' %}
                                    <span class="badge bg-info">Medium</span>
                                {% else %}
                                    <span class="badge bg-success">Low</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if app.review_status == 'submitted' %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i>Pending
                                    </span>
                                {% elif app.review_status == 'in_review' %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-eye me-1"></i>In Review
                                    </span>
                                {% elif app.review_status == 'completed' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Completed
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-question me-1"></i>Unknown
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ app.earliest_review_date[:16].replace('T', ' ') if app.earliest_review_date else 'N/A' }}</small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="reviewDropdown{{ app.application_id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-eye"></i> Select Review
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="reviewDropdown{{ app.application_id }}">
                                            {% for review in app.reviews %}
                                            <li>
                                                <a class="dropdown-item" href="{{ url_for('analyst_review_detail', review_id=review.id) }}">
                                                    {% if review.field_type == 'application_review' %}
                                                        <i class="fas fa-desktop me-2"></i>Application Review
                                                    {% elif review.field_type == 'cloud_review' %}
                                                        <i class="fas fa-cloud me-2"></i>Cloud Review
                                                    {% else %}
                                                        <i class="fas fa-file me-2"></i>{{ review.field_type|title }}
                                                    {% endif %}
                                                    <span class="badge ms-2 
                                                        {% if review.status == 'submitted' %}bg-warning text-dark
                                                        {% elif review.status == 'in_review' %}bg-info
                                                        {% elif review.status == 'completed' %}bg-success
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ review.status|title }}
                                                    </span>
                                                </a>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-clipboard-list fa-3x text-muted"></i>
                </div>
                <h5 class="text-muted">No Applications Assigned</h5>
                <p class="text-muted">You don't have any applications with security reviews assigned yet.</p>
                <a href="{{ url_for('web_dashboard') }}" class="btn btn-primary">
                    <i class="fas fa-tachometer-alt"></i> Back to Dashboard
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %} 