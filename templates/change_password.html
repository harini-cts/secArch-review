{% extends "base.html" %}

{% block title %}Change Password - Cognizant SecArch Portal{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-key"></i> Change Password</h4>
                </div>
                <div class="card-body">
                    <!-- Security Notice -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading">Password Security Tips</h6>
                                <ul class="mb-0 small">
                                    <li>Use at least 8 characters</li>
                                    <li>Include uppercase and lowercase letters</li>
                                    <li>Include numbers and special characters</li>
                                    <li>Avoid common words or personal information</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <form method="POST" id="changePasswordForm">
                        <!-- Current Password -->
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="current_password" name="current_password" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                    <i class="fas fa-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="new_password" name="new_password" required minlength="8">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                    <i class="fas fa-eye" id="new_password_icon"></i>
                                </button>
                            </div>
                            <!-- Password Strength Indicator -->
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar" id="password_strength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="password_feedback">Enter a password to see strength</small>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                    <i class="fas fa-eye" id="confirm_password_icon"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="password_match_feedback"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('web_profile') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit_btn" disabled>
                                <i class="fas fa-save"></i> Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Additional Security Information -->
            <div class="card mt-4 border-warning">
                <div class="card-body">
                    <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Security Reminder</h6>
                    <ul class="text-muted small mb-0">
                        <li>You will be logged out after changing your password</li>
                        <li>Make sure to save your new password in a secure location</li>
                        <li>If you suspect your account has been compromised, change your password immediately</li>
                        <li>Consider enabling two-factor authentication for additional security</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = '';
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]+/)) strength += 1;
    if (password.match(/[A-Z]+/)) strength += 1;
    if (password.match(/[0-9]+/)) strength += 1;
    if (password.match(/[$@#&!]+/)) strength += 1;
    
    const strengthBar = document.getElementById('password_strength');
    const feedbackElement = document.getElementById('password_feedback');
    
    switch (strength) {
        case 0:
        case 1:
            strengthBar.style.width = '20%';
            strengthBar.className = 'progress-bar bg-danger';
            feedback = 'Very Weak';
            break;
        case 2:
            strengthBar.style.width = '40%';
            strengthBar.className = 'progress-bar bg-warning';
            feedback = 'Weak';
            break;
        case 3:
            strengthBar.style.width = '60%';
            strengthBar.className = 'progress-bar bg-info';
            feedback = 'Fair';
            break;
        case 4:
            strengthBar.style.width = '80%';
            strengthBar.className = 'progress-bar bg-primary';
            feedback = 'Good';
            break;
        case 5:
            strengthBar.style.width = '100%';
            strengthBar.className = 'progress-bar bg-success';
            feedback = 'Strong';
            break;
    }
    
    feedbackElement.textContent = feedback;
    return strength >= 3;
}

function validatePasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const feedback = document.getElementById('password_match_feedback');
    const confirmField = document.getElementById('confirm_password');
    
    if (confirmPassword && newPassword !== confirmPassword) {
        confirmField.classList.add('is-invalid');
        feedback.textContent = 'Passwords do not match';
        return false;
    } else {
        confirmField.classList.remove('is-invalid');
        feedback.textContent = '';
        return true;
    }
}

function updateSubmitButton() {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const submitBtn = document.getElementById('submit_btn');
    
    const isStrong = checkPasswordStrength(newPassword);
    const isMatch = validatePasswordMatch();
    const allFilled = currentPassword && newPassword && confirmPassword;
    
    submitBtn.disabled = !(isStrong && isMatch && allFilled);
}

// Event listeners
document.getElementById('new_password').addEventListener('input', updateSubmitButton);
document.getElementById('confirm_password').addEventListener('input', updateSubmitButton);
document.getElementById('current_password').addEventListener('input', updateSubmitButton);

// Form validation
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
        return false;
    }
    
    if (!checkPasswordStrength(newPassword)) {
        e.preventDefault();
        alert('Password is too weak. Please choose a stronger password.');
        return false;
    }
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.input-group .btn {
    border-left: none;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn {
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
}

.btn-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
}

.progress {
    border-radius: 10px;
}

.alert {
    border: none;
    border-radius: 10px;
}
</style>
{% endblock %} 